name: TestSprite AI Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  testsprite:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Build Project
        run: dotnet build --configuration Release
      
      - name: Install TestSprite CLI
        run: npm install -g @testsprite/cli
      
      - name: Start TestSprite Agent
        run: |
          npx -y @testsprite/ci-agent \
            --api-key ${{ secrets.TESTSPRITE_API_KEY }} \
            --mcp-config .testsprite/mcp.json
      
      - name: Discover Tests
        run: |
          npx -y @testsprite/cli discover \
            --source ./src \
            --output tests.json
      
      - name: Execute Tests
        run: |
          npx -y @testsprite/cli run \
            --tests tests.json \
            --parallel 4 \
            --coverage \
            --output results/
      
      - name: Self-Healing Validation
        if: failure()
        run: |
          npx -y @testsprite/cli heal \
            --results results/ \
            --attempts 3 \
            --confidence-threshold 0.85
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: testsprite-results
          path: results/
