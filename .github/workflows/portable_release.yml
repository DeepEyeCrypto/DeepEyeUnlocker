name: DeepEye Portable - Cross-Platform Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Build Core (Android)
        run: |
          cd portable/core
          # Building for multiple ABIs would happen here in a real NDK project
          mkdir build && cd build
          cmake .. -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_LATEST_HOME/build/cmake/android.toolchain.cmake \
                   -DANDROID_ABI=arm64-v8a -DANDROID_PLATFORM=android-26
          make deepeye_core

      - name: Build Android APK
        run: |
          cd portable/android
          gradle assembleRelease

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: deepeye-portable-apk
          path: portable/android/app/build/outputs/apk/release/*.apk

  build-desktop:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libusb-1.0-0-dev cmake build-essential

      - name: Build Core & CLI (Desktop)
        run: |
          cd portable/core
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make deepeye_core
          cd ../../desktop
          g++ main.cpp -I../core/include -o deepeye_cli -L../core/build -ldeepeye_core

      - name: Package Desktop Release
        run: |
          mkdir -p release_zip
          cp portable/desktop/deepeye_cli release_zip/
          cp portable/core/build/libdeepeye_core.so release_zip/
          cp docs/portable_otg_architecture.md release_zip/README.md
          zip -r deepeye_portable_desktop.zip release_zip/

      - name: Upload Desktop Zip
        uses: actions/upload-artifact@v4
        with:
          name: deepeye-portable-zip
          path: deepeye_portable_desktop.zip
